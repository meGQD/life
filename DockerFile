# Step 1: Build Stage
FROM python:3.11.10-alpine3.20 AS builder

RUN apk add --no-cache \
    gcc \
    musl-dev \
    postgresql-dev \
    libpq

WORKDIR /app

COPY Pipfile Pipfile.lock /app/
RUN pip install pipenv

# Install dependencies in build stage
RUN pipenv install --deploy --ignore-pipfile

COPY . /app/

CMD python manage.py migrate && \
    gunicorn lifefront.wsgi:application --workers 3 --timeout 60

# Step 2: Production Stage
FROM python:3.11.10-alpine3.20

RUN apk add --no-cache libpq
WORKDIR /app

# Copy app files from builder
COPY --from=builder /app /app

# Install pipenv in production stage
RUN pip install pipenv

# Install packages to the system path directly
RUN pipenv install --system --deploy --ignore-pipfile

# Set up the command
CMD python manage.py collectstatic --no-input